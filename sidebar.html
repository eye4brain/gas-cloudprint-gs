<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<link rel="stylesheet" type="text/css" href="https://dl.dropboxusercontent.com/u/3688633/cssman/insert.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>
    google.load("visualization", "1", {packages:["corechart"]});
    google.setOnLoadCallback(test);
    
    var setPrinterID = "";
    
    function test(){
      google.script.run.withSuccessHandler(onSuccess).setbackurl();
      google.script.run.withSuccessHandler(onSuccess2).setclienid();
      google.script.run.withSuccessHandler(onSuccess3).isTokenValid();
      google.script.run.withSuccessHandler(onSuccess4).setSecret();
      //google.script.run.withSuccessHandler(onSuccess5).domainurl();
      google.script.run.withSuccessHandler(myPrinter).getSetPrinter();
      google.script.run.withSuccessHandler(onPrinter).getPrinterList();
    }
    
    $(function(){
        $('#btnOK').click(function(){
            google.script.run.oauthcallback();
        });
    });

    $(function(){
        $('#btnOK2').click(function(){
            google.script.run.oauthclientid();
        });
    });
    
    $(function(){
        $('#btnOK3').click(function(){
            google.script.run.oauthSecret();
        });
    });
    
    $(function(){
        $('#btnOK4').click(function(){
            google.script.run.startoauth();
        });
    });
    
    $(function(){
        $('#btnOK5').click(function(){
            google.script.run.setDomain();
        });
    });

    $(function(){
        $('#btnOK6').click(function(){
            google.script.run.testpdf();
        });
    });

    $(function(){
        $('#btnOK7').click(function(){
            google.script.run.withSuccessHandler(prinresult).testprint();
        });
    });
    
    function onSuccess(data){
    　if(data != "未選択"){
         document.getElementById("test").innerHTML = "CallBack URL：<b>登録済み</b>";
      }
    }

    function onSuccess2(data){
      if(data != "未選択"){
        document.getElementById("test2").innerHTML = "ClientID：<b>登録済み</b>";
      }
    }

    function onSuccess3(data){
      if(data == true){
        document.getElementById("test4").innerHTML = "状態：<b>認証済み</b>";
      }
    }

    function onSuccess4(data){
      if(data != "未選択"){
        document.getElementById("test3").innerHTML = "ClientSecret：<b>登録済み</b>";
      }
    }
    
    function myPrinter(ret){
      setPrinterID = ret;
    }
    
    //有効なプリンターリストがあればメニューを作る
    function onPrinter(data){
      var json = JSON.parse(data);
      var status = json[0];
      var html = "<p>";
      
      switch(status){
        case "NG":
          html = "OAuth認証ができていません。";
          break;
        case "NULL":
          html = "オンラインなプリンターがありません";
          break;
        case "OK":
          var array = json[1];
          var alength = array.length;
          html = "<select id='prinid'><option>プリンターを選択</option>";
          
          for(var i = 0;i<alength;i++){
            if(array[i][1] == setPrinterID){
              html += "<option value='" + array[i][1] + "' selected>" + array[i][0] + "</option>";
            }else{
              html += "<option value='" + array[i][1] +  "'>" + array[i][0] + "</option>";
            }
          }
          break;
      }
      
      html += "</select></p>"
      
      //ボタンを追加する
      html += "<p><button class='action' onClick='prinSet();'>選択</button></p>"
    
      //htmlを反映する
      document.getElementById("printman").innerHTML = html;
      
    }
    
    function prinSet(){
      var value = document.getElementById("prinid").value;
      
      if(value == "プリンターを選択"){
        alert("プリンターを選んでくださいよ。");
      }else{
        google.script.run.withSuccessHandler(retHello).setDefPrinter(value);
      }
    }
    
    function retHello(data){
      alert(data);
    }
    
    function prinresult(data){
      var json = JSON.parse(data);
      
      if(json[0] == "OK"){
        alert("印刷されましたよ");
      }else{
        alert(json[1]);
      }
    }

    function clickfunc(obj) {
      var num = Number(obj.title);
      google.script.run.insertPara(num);
      return false;
    }
</script>
<style>
    div.wasabi{
      padding:3px 5px;
      border-color:#0B0099;
      border-width:0 0 1px 7px;
      border-style:solid;
      background:#F8F8F8;
      vertical-align: middle;
    }
    div.kousin {
      overflow-y: auto;
      width:95%; height:200px;
      padding:3px;
      border:1px solid #000;
      color:#000000;
      background-color:#ffffff;
      line-height:1.0em;
      margin-left: auto;
      margin-right: auto;
    }
    div.boxContainer {
      overflow: hidden;
      width:100%;
    }
    .box {
      float: left;
      width: 100%;
      margin-right:5px;
    }
    #linkArea{
      position: relative;
      width: 100%;
      height: 100%;
      border-color: #999999;
      border-style: none;
    }
    #linkArea a{
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
</style>
<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/callBack.gif' border='0'>&nbsp;&nbsp;コールバックURL</div>
<p><button id="btnOK" class="action">URL登録</button></p>
<div id="test">CallBack URL：未登録</div><p>
<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/blue-linux-client-16.jpg'>&nbsp;&nbsp;クライアントID</div><p>
<p><button id="btnOK2" class="action">IDの登録</button></p>
<div id="test2">ClientID：未登録</div><p>
<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/blue-linux-client-16.jpg'>&nbsp;&nbsp;クライアントシークレット</div><p>
<p><button id="btnOK3" class="action">シークレットコードの登録</button></p>
<div id="test3">Client Secret：未登録</div><p>
<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/lock.png'>&nbsp;&nbsp;OAuth2.0認証の実行</div><p>
<p><button id="btnOK4" class="create">認証実行</button></p>
<div id="test4">状態：未認証</div><p>
<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/lock.png'>&nbsp;&nbsp;ドメインの登録</div><p>
<p><button id="btnOK5" class="create">ドメイン登録</button></p>
<div id="test5">状態：未登録</div><p>
<p>ドメイン登録は、Google Apps for Your Domainにて運用してる企業内で使用する場合に、スプレッドシートのURLが通常とは異なる為、それに対応
するためのオプションです。そうでない場合は空のままで結構です（例：kinoko.net）</p>

<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/printer_icon.gif'>&nbsp;&nbsp;プリンタの選択</div><p>
<div id="printman"></div>

<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/icon_pdf.gif'>&nbsp;&nbsp;PDFのテスト送信</div><p>
<p><button id="btnOK6" class="create">テスト送信</button></p>
きちんと認証を完了していれば、いちごタルトのPDFが作成されて送信されます。ボタンを押した人の所に届きますので、管理者に届くわけではありません。

<div class="wasabi"><img src='https://dl.dropboxusercontent.com/u/3688633/icons/icon_pdf.gif'>&nbsp;&nbsp;テスト印刷</div><p>
<p><button id="btnOK7" class="create">テスト送信</button></p>
きちんと認証を完了していれば、対象のプリンターから印刷がされますよ。